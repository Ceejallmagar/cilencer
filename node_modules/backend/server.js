const express = require('express');
const cors = require('cors');
const dotenv = require('dotenv');
const admin = require('firebase-admin');

// Load environment variables first
dotenv.config();

// Initialize Firebase Admin
try {
    const serviceAccount = require('./serviceAccountKey.json');
    admin.initializeApp({
        credential: admin.credential.cert(serviceAccount),
        storageBucket: 'silence-booster.appspot.com'
    });
    console.log('âœ… Firebase Admin initialized successfully');
} catch (error) {
    console.error('âŒ Firebase Admin initialization failed:', error.message);
    process.exit(1);
}

const app = express();
const PORT = process.env.PORT || 5001;

// Middleware
// Middleware to log origin and handle private network preflights
app.use((req, res, next) => {
    const origin = req.get('origin');
    if (origin) {
        console.log(`[CORS Debug] Request from origin: ${origin}`);
    }
    // Allow private network preflights (Chrome 94+)
    if (req.headers['access-control-request-private-network']) {
        res.setHeader('Access-Control-Allow-Private-Network', 'true');
    }
    next();
});

app.use(cors({
    origin: (origin, callback) => {
        // permissive regex for local network and known domains
        const localRegex = /^https?:\/\/(localhost|127\.0\.0\.1|192\.168\.\d+\.\d+|10\.\d+\.\d+\.\d+|172\.(?:1[6-9]|2\d|3[0-1])\.\d+\.\d+)(?::\d+)?$/;

        if (!origin ||
            localRegex.test(origin) ||
            origin.endsWith('.vercel.app') ||
            origin === 'https://cilencer.vercel.app' ||
            origin.startsWith('http://192.168.') // fallback check
        ) {
            callback(null, true);
        } else {
            console.log(`[CORS Blocked] Origin: ${origin}`);
            callback(new Error('Not allowed by CORS'));
        }
    },
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'Accept', 'Origin', 'Cache-Control', 'Pragma', 'Expires'],
    optionsSuccessStatus: 200
}));
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ limit: '50mb', extended: true }));

// Serve uploaded files statically
app.use('/uploads', express.static('uploads'));

// Health check
app.get('/', (req, res) => {
    res.json({
        message: 'Silence Booster Backend is running!',
        version: '1.0.0',
        endpoints: [
            '/api/auth',
            '/api/users',
            '/api/posts',
            '/api/memewar',
            '/api/trolls',
            '/api/notifications',
            '/api/admin'
        ]
    });
});

// Routes
app.use('/api/auth', require('./routes/auth'));
app.use('/api/users', require('./routes/users'));
app.use('/api/posts', require('./routes/posts'));
app.use('/api/memewar', require('./routes/memewar'));
app.use('/api/trolls', require('./routes/trolls'));
app.use('/api/notifications', require('./routes/notifications'));
app.use('/api/admin', require('./routes/admin'));
app.use('/api/ads', require('./routes/ads'));

// Error handling middleware
app.use((err, req, res, next) => {
    console.error('Server error:', err);
    res.status(500).json({ error: 'Internal server error' });
});

// 404 handler
app.use((req, res) => {
    res.status(404).json({ error: 'Route not found' });
});

app.listen(PORT, '0.0.0.0', () => {
    console.log(`ðŸš€ Silence Booster Server running on port ${PORT}`);
    console.log(`ðŸ“¡ API available at http://localhost:${PORT} (and http://192.168.16.107:${PORT})`);
});
